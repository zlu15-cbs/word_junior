<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Word Definition Quiz – Build & Play</title>
  <meta name="description" content="Paste a list of words and get an instant multiple‑choice quiz on their definitions. Share via a simple link." />
  <style>
    :root {
      --bg: #0b1020;
      --card: #121a33;
      --ink: #e9ecf1;
      --ink-dim: #b7c0d1;
      --accent: #5da9ff;
      --accent-2: #9b7dff;
      --danger: #ff6b6b;
      --success: #2ecc71;
      --muted: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-xs: 8px;
      --focus: 0 0 0 3px rgba(93,169,255,.4), 0 0 0 1px rgba(93,169,255,.9);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f9fc;
        --card: #ffffff;
        --ink: #131722;
        --ink-dim: #4b5466;
        --accent: #0b6bff;
        --accent-2: #7a52ff;
        --muted: rgba(0,0,0,.05);
        --border: rgba(0,0,0,.08);
        --shadow: 0 10px 25px rgba(0,0,0,.08);
      }
    }
    html, body {
      height: 100%;
      margin: 0;
      background:
        radial-gradient(1200px 800px at 110% -10%, rgba(155,125,255,.15), transparent 60%),
        radial-gradient(900px 600px at -10% -10%, rgba(93,169,255,.18), transparent 60%),
        var(--bg);
      color: var(--ink);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container {
      max-width: 950px;
      margin: 28px auto 80px;
      padding: 0 18px;
    }
    header.hero {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin: 8px auto 22px;
      text-align: center;
    }
    .brand {
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 26px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      line-height: 1;
    }
    .logo {
      display: inline-grid;
      place-items: center;
      width: 34px; height: 34px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      border-radius: 8px;
      font-weight: 900;
      box-shadow: var(--shadow);
      transform: rotate(-8deg);
    }
    .subtitle { color: var(--ink-dim); margin-top: 2px; }
    .card {
      background: linear-gradient(180deg, var(--card), color-mix(in oklab, var(--card) 90%, black));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px;
    }
    .pad { padding: 20px; }
    .grid {
      display: grid;
      gap: 16px;
    }
    .grid.two { grid-template-columns: 1fr 1fr; }
    @media (max-width: 820px) {
      .grid.two { grid-template-columns: 1fr; }
    }
    .muted { color: var(--ink-dim); }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .spacer { flex: 1 1 auto; }
    .btn {
      --b: var(--border);
      --bg-btn: color-mix(in oklab, var(--accent) 35%, transparent);
      --ink-btn: white;
      appearance: none;
      border: 1px solid var(--b);
      background: linear-gradient(135deg, var(--bg-btn), color-mix(in oklab, var(--accent-2) 30%, transparent));
      color: var(--ink-btn);
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .25px;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
      transition: transform .05s ease, filter .2s ease;
      user-select: none;
    }
    .btn:hover { filter: brightness(1.04); }
    .btn:active { transform: translateY(1px) scale(.995); }
    .btn.secondary {
      --bg-btn: var(--muted);
      --ink-btn: var(--ink);
      background: var(--muted);
      border: 1px solid var(--border);
      box-shadow: none;
      font-weight: 600;
    }
    .btn.ghost {
      background: transparent;
      color: var(--ink);
      border: 1px dashed var(--border);
      box-shadow: none;
    }
    .btn.danger { --bg-btn: color-mix(in oklab, var(--danger) 70%, transparent); }
    .btn.success { --bg-btn: color-mix(in oklab, var(--success) 65%, transparent); }
    .btn:focus-visible { outline: none; box-shadow: var(--focus); }
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 12px 14px;
      background: var(--muted);
      color: var(--ink);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-sizing: border-box;
      font: inherit;
    }
    textarea { min-height: 120px; resize: vertical; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    .hint { font-size: 12px; color: var(--ink-dim); margin-top: 6px; }
    .row { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
    .chip {
      display: inline-block;
      background: var(--muted);
      border: 1px solid var(--border);
      color: var(--ink-dim);
      padding: 6px 10px; border-radius: 100px; font-weight: 600; font-size: 12px;
    }
    .inline-input { display: flex; gap: 6px; align-items: center; }
    .inline-input input[type="checkbox"] { width: 18px; height: 18px; }
    .stack { display: grid; gap: 10px; }
    .progress {
      height: 10px; background: var(--muted); border-radius: 999px; overflow: hidden; border: 1px solid var(--border);
    }
    .progress .bar {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width .25s ease;
    }
    .question-card { display: grid; gap: 10px; }
    .question-title {
      font-size: 20px; font-weight: 800;
    }
    .choices {
      display: grid; gap: 10px;
    }
    .choice {
      display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: start;
      padding: 12px; border-radius: var(--radius-sm);
      background: var(--muted); border: 1px solid var(--border);
      cursor: pointer;
    }
    .choice input { margin-top: 4px; }
    .choice:hover { filter: brightness(1.03); }
    .choice.correct { border-color: color-mix(in oklab, var(--success) 60%, var(--border)); background: color-mix(in oklab, var(--success) 16%, var(--muted)); }
    .choice.incorrect { border-color: color-mix(in oklab, var(--danger) 60%, var(--border)); background: color-mix(in oklab, var(--danger) 16%, var(--muted)); }
    .feedback {
      padding: 10px 12px; border-radius: var(--radius-xs);
      border: 1px solid var(--border); background: var(--muted); color: var(--ink);
      display: none;
    }
    .feedback.show { display: block; }
    .kicker { font-weight: 900; letter-spacing: .4px; text-transform: uppercase; font-size: 12px; color: var(--ink-dim); }
    .pos { font-weight: 700; color: var(--ink-dim); margin-left: 8px; }
    .topbar {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
      margin-bottom: 12px;
    }
    footer {
      text-align: center; color: var(--ink-dim); margin: 30px 0 10px;
      font-size: 13px;
    }
    code.kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: var(--muted); border: 1px solid var(--border); padding: 1px 6px; border-radius: 6px;
    }
    .small { font-size: 13px; color: var(--ink-dim); }
    .error {
      background: color-mix(in oklab, var(--danger) 15%, var(--muted));
      border: 1px solid color-mix(in oklab, var(--danger) 50%, var(--border));
      color: var(--ink);
      padding: 10px 12px; border-radius: var(--radius-xs);
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero">
      <div class="brand">
        <span class="logo" aria-hidden="true">Q</span>
        Word Definition Quiz
      </div>
      <div class="subtitle">Paste words ➜ get a multiple‑choice quiz ➜ share a link.</div>
    </header>

    <!-- Builder (shows if there are no ?words= params) -->
    <section id="builder" class="card grid" role="region" aria-label="Quiz builder">
      <div class="grid">
        <div class="stack">
          <label for="words">Words (comma or newline separated)</label>
          <textarea id="words" spellcheck="false" placeholder="e.g., philanthropy, obsequious, emancipated, jurisdiction, doctrine, converge, equivocate">philanthropy, obsequious, emancipated, jurisdiction, doctrine, converge, equivocate</textarea>
          <div class="row">
            <div class="inline-input">
              <label for="choices-count">Choices per question</label>
              <input id="choices-count" type="number" min="2" max="6" value="4" style="width: 84px" />
            </div>
            <div class="inline-input">
              <input id="show-examples" type="checkbox" checked />
              <label for="show-examples">Show example sentence after answering</label>
            </div>
            <div class="inline-input">
              <input id="shuffle-seed" type="text" placeholder="Random seed (optional)" style="width: 220px" />
            </div>
            <span class="chip">No sign‑ups. Pure client‑side.</span>
          </div>
          <div class="controls">
            <button id="build-quiz" class="btn">Build quiz</button>
            <button id="try-sample" class="btn secondary">Use sample words</button>
            <span class="spacer"></span>
            <button id="copy-share" class="btn ghost" title="Copies a shareable link with your words">Copy share link</button>
          </div>
          <div id="builder-msg" class="hint">Tip: After you click <b>Build quiz</b>, you can share the page URL with your student—no hosting required if you send the file, or enable GitHub Pages for a web link.</div>
        </div>
      </div>
    </section>

    <!-- Loader -->
    <section id="loading" class="card" hidden>
      <div class="stack">
        <div class="kicker">Building your quiz…</div>
        <div class="progress"><div class="bar" id="load-bar"></div></div>
        <div id="load-status" class="small">Fetching definitions…</div>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="card" hidden>
      <div class="topbar">
        <div class="progress"><div class="bar" id="progress-bar"></div></div>
        <div id="score" class="chip" aria-live="polite">Score: 0 / 0</div>
      </div>
      <div id="q-wrap" class="grid"></div>
      <div class="controls" style="margin-top: 12px;">
        <button id="prev" class="btn secondary">Previous</button>
        <button id="next" class="btn">Next</button>
        <button id="finish" class="btn success">Finish</button>
        <span class="spacer"></span>
        <button id="new-quiz" class="btn ghost">Build new quiz</button>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="card" hidden>
      <div class="stack">
        <div class="kicker">Results</div>
        <h2 id="final-score" style="margin: 0 0 6px 0;"></h2>
        <div id="summary" class="small"></div>
        <div class="controls" style="margin-top: 8px;">
          <button id="retry" class="btn">Try again (reshuffle)</button>
          <button id="copy-share-2" class="btn ghost">Copy share link</button>
          <span class="spacer"></span>
          <button id="builder-again" class="btn secondary">Build a different quiz</button>
        </div>
        <div id="review" class="grid" style="margin-top: 12px;"></div>
      </div>
    </section>

    <footer>
      <p class="small">Definitions fetched live from the <a href="https://dictionaryapi.dev/" target="_blank" rel="noopener">Free Dictionary API</a>. Your data never leaves your browser.</p>
    </footer>
  </div>

<script type="module">
/* ---------- Utilities ---------- */
const $ = (q, el=document) => el.querySelector(q);
const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms)}; }

// Deterministic RNG (seeded) – xmur3 + mulberry32
function xmur3(str) {
  let h = 1779033703 ^ str.length;
  for (let i=0; i<str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = (h << 13) | (h >>> 19);
  }
  return function() {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return (h ^= h >>> 16) >>> 0;
  };
}
function mulberry32(a) {
  return function() {
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
function seededShuffle(array, rng) {
  const a = array.slice();
  for (let i=a.length-1; i>0; i--) {
    const j = Math.floor(rng() * (i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
const STOPWORDS = new Set("a,an,the,of,to,in,on,and,or,from,for,at,by,with,as,into,so,that,is,are,was,were,be,being,been,which,who,whom,whose,than,then,this,those,these,it,its,their,there,here,over,under,up,down,between,through,about,around,against,across,any,each,either,neither,both,all,more,most,very,just,may,might,can,could,should,would".split(","));
function tokenize(s) {
  return s.toLowerCase()
    .replace(/[^a-z0-9\s-']/g, " ")
    .split(/\s+/).filter(w => w && !STOPWORDS.has(w));
}
function jaccard(a, b) {
  const A = new Set(a), B = new Set(b);
  let inter = 0;
  A.forEach(x => { if (B.has(x)) inter++; });
  const union = A.size + B.size - inter;
  return union ? inter / union : 0;
}
function cleanDefinition(def) {
  if (!def) return "";
  let d = def.trim();
  d = d.replace(/\s*\([^)]*\)\s*/g, " "); // remove parentheticals
  d = d.replace(/\s*;.*$/, ""); // drop clause after semicolon (often examples)
  d = d.replace(/\s{2,}/g, " ").trim();
  return d.length > 220 ? d.slice(0, 217) + "…" : d;
}
function getParam(name) {
  const u = new URL(location.href);
  return u.searchParams.get(name);
}
function setParams(params) {
  const u = new URL(location.href);
  for (const [k,v] of Object.entries(params)) {
    if (v === null || v === undefined || v === "") u.searchParams.delete(k);
    else u.searchParams.set(k, v);
  }
  history.replaceState(null, "", u.toString());
}
function parseWordsFromParams() {
  const u = new URL(location.href);
  let raw = u.searchParams.get("words") || "";
  if (!raw && location.hash.startsWith("#words=")) {
    raw = decodeURIComponent(location.hash.slice(7));
  }
  const items = raw.split(/[\n,]/).map(s => s.trim()).filter(Boolean);
  // Deduplicate while preserving order
  const seen = new Set();
  const out = [];
  for (const w of items) {
    const key = w.toLowerCase();
    if (!seen.has(key)) { seen.add(key); out.push(w); }
  }
  return out;
}
function copyToClipboard(text) {
  return navigator.clipboard?.writeText(text).catch(()=>{
    const ta = document.createElement("textarea");
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
  });
}
/* ---------- Fallback mini-dictionary (for your sample words) ---------- */
const FALLBACK = {
  "philanthropy": { pos: "noun", defs: [
    "the desire to promote the welfare of others, expressed especially by the generous donation of money to good causes"
  ]},
  "obsequious": { pos: "adjective", defs: [
    "obedient or attentive to an excessive or servile degree"
  ]},
  "emancipated": { pos: "adjective", defs: [
    "freed from legal, social, or political restrictions; liberated"
  ]},
  "jurisdiction": { pos: "noun", defs: [
    "the official power to make legal decisions and judgments"
  ]},
  "doctrine": { pos: "noun", defs: [
    "a belief or set of beliefs taught and held by a church, political party, or other group"
  ]},
  "converge": { pos: "verb", defs: [
    "to come together from different directions; meet"
  ]},
  "equivocate": { pos: "verb", defs: [
    "to use ambiguous language to conceal the truth or avoid committing oneself"
  ]}
};
// Generic distractor pool – short, definition‑like statements
const GENERIC_DISTRACTORS = [
  "a device for measuring temperature",
  "a plant that loses its leaves seasonally",
  "a small, narrow river",
  "the study of past human activity",
  "a heavy fabric used for warmth",
  "a written account of daily events",
  "the outer layer of the Earth",
  "a musical composition for one instrument",
  "a building where objects of historical interest are displayed",
  "a person who studies the stars and planets",
  "a large body of salt water",
  "a tool used to drive nails",
  "a feeling of extreme happiness",
  "a public place for borrowing books",
  "a tool that shows direction using a magnetic needle",
  "a protective covering worn on the head",
  "a long journey by sea",
  "a machine that computes and processes data",
  "a comparison using like or as",
  "a figure of speech giving human traits to nonhuman things",
  "a map used by travelers on roads",
  "the layer of gases surrounding a planet",
  "a person who leads a group",
  "an area set aside to protect wildlife",
  "a period of ten years",
  "the money paid for the use of property",
  "an official count of a population",
  "a strong desire to succeed",
  "a person who writes news articles",
  "a chemical that speeds up a reaction",
  "the process of plants making food from sunlight",
  "a solid figure with six equal square faces",
  "the ability to do something well",
  "a long narrative poem",
  "a very small piece or amount",
  "a person who practices law",
  "a statement of what will happen in the future",
  "the time when day changes to night",
  "the main idea of a passage"
];

/* ---------- Data fetching ---------- */

async function fetchDefinitions(word) {
  // Merriam-Webster School Dictionary (sd2)
  const endpoint = "https://dictionaryapi.com/api/v3/references/sd2/json/" + encodeURIComponent(word) + "?key=b6064719-257f-42a8-879d-d3094f6b8cfc";

  // Helper to extract an example sentence if present
  function extractExample(entry) {
    try {
      const defs = entry.def || [];
      for (const d of defs) {
        const sseq = d.sseq || [];
        for (const senseWrap of sseq) {
          for (const sense of senseWrap) {
            const data = (sense && sense[1]) || {};
            const dt = data.dt || [];
            for (const item of dt) {
              if (Array.isArray(item) && item[0] === "vis" && Array.isArray(item[1]) && item[1][0] && item[1][0].t) {
                return String(item[1][0].t).replace(/\{[^}]+\}/g, "").trim();
              }
            }
          }
        }
      }
    } catch (e) {}
    return "";
  }

  try {
    const res = await fetch(endpoint, { mode: "cors" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();

    if (!Array.isArray(json) || json.length === 0) throw new Error("No results");

    // If MW returns suggestions (array of strings), treat as not found
    if (typeof json[0] === "string") {
      return { ok: false, error: "No definition; suggestions returned." };
    }

    const entries = [];
    for (const ent of json) {
      if (!ent || typeof ent !== "object") continue;
      const pos = ent.fl || ""; // part of speech
      const shorts = Array.isArray(ent.shortdef) ? ent.shortdef : [];
      const example = extractExample(ent);
      for (const s of shorts) {
        if (typeof s === "string" && s.trim()) {
          entries.push({
            word,
            pos,
            definition: cleanDefinition(s),
            example
          });
        }
      }
    }

    // Deduplicate by pos+definition
    const seen = new Set();
    const final = entries.filter(e => {
      const key = (e.pos + "|" + e.definition).toLowerCase();
      if (!e.definition || seen.has(key)) return false;
      seen.add(key); return true;
    });

    if (final.length) return { ok: true, entries: final, source: "merriam-webster" };

    // Fallback to built-in sample definitions (if present)
    const key = word.toLowerCase();
    if (typeof FALLBACK !== "undefined" && FALLBACK[key]) {
      const pos = FALLBACK[key].pos || "";
      const entries = FALLBACK[key].defs.map(d => ({ word, pos, definition: d, example: "" }));
      return { ok: true, entries, source: "fallback" };
    }

    return { ok: false, error: "No definitions found" };
  } catch (err) {
    // Fallback on error too
    const key = word.toLowerCase();
    if (typeof FALLBACK !== "undefined" && FALLBACK[key]) {
      const pos = FALLBACK[key].pos || "";
      const entries = FALLBACK[key].defs.map(d => ({ word, pos, definition: d, example: "" }));
      return { ok: true, entries, source: "fallback" };
    }
    return { ok: false, error: String(err) };
  }
}

      }
    }
    // Dedup + keep concise
    const seen = new Set();
    const final = entries.filter(e => {
      const key = e.definition.toLowerCase();
      if (!e.definition || seen.has(key)) return false;
      seen.add(key); return true;
    });
    if (final.length) return { ok: true, entries: final, source: "dictionaryapi.dev" };
    throw new Error("No definitions found");
  } catch (err) {
    // Fallback for sample words
    const key = word.toLowerCase();
    if (FALLBACK[key]) {
      const pos = FALLBACK[key].pos || "";
      const entries = FALLBACK[key].defs.map(d => ({ word, pos, definition: d, example: "" }));
      return { ok: true, entries, source: "fallback" };
    }
    return { ok: false, error: String(err) };
  }
}

async function buildQuizFromWords(words, { choices=4, seed="", showExamples=true } = {}) {
  const seedStr = seed || String(Math.floor(Math.random()*1e9));
  const rand = mulberry32(xmur3(seedStr)());
  const loadBar = $("#load-bar");
  const loadStatus = $("#load-status");

  $("#builder").hidden = true;
  $("#loading").hidden = false;
  loadBar.style.width = "0%";

  // Fetch definitions (limit concurrent bursts to be polite)
  const results = [];
  let done = 0;
  const total = words.length;
  const tasks = words.map(async (w) => {
    const r = await fetchDefinitions(w);
    done++;
    const pct = Math.round((done/Math.max(total,1))*100);
    loadBar.style.width = pct + "%";
    loadStatus.textContent = `Fetched ${done}/${total} (${pct}%)`;
    results.push({ word: w, ...r });
  });
  await Promise.allSettled(tasks);

  const good = results.filter(r => r.ok);
  const bad = results.filter(r => !r.ok);
  if (good.length === 0) {
    $("#loading").hidden = true;
    $("#builder").hidden = false;
    $("#builder-msg").innerHTML = '<span class="error">Could not fetch definitions. Check your spelling or internet connection.</span>';
    return;
  }

  // Pool of candidate distractor definitions from all words' top entries
  const pool = [];
  for (const r of good) {
    // prefer the shortest clear definition for clarity
    const sorted = r.entries.slice().sort((a,b) => a.definition.length - b.definition.length);
    const top = sorted[0];
    if (top) pool.push({ word: r.word, text: top.definition });
  }

  // Build quiz items
  const items = [];
  for (const r of good) {
    // pick a primary definition (shortest nontrivial)
    const defs = r.entries.slice().sort((a,b) => a.definition.length - b.definition.length);
    const primary = defs[0];
    if (!primary) continue;

    const correct = cleanDefinition(primary.definition);
    const correctTokens = tokenize(correct);

    // Collect distractors from other words' definitions
    let distractors = pool
      .filter(p => p.word !== r.word)
      .map(p => p.text)
      .filter(Boolean);

    // Remove items that are too similar (e.g., synonyms)
    distractors = distractors.filter(d => jaccard(correctTokens, tokenize(d)) < 0.5);

    // Shuffle and take
    distractors = seededShuffle(distractors, rand).slice(0, Math.max(0, choices - 1));

    // If not enough, top up with generic distractors (also de‑similarized)
    for (const g of seededShuffle(GENERIC_DISTRACTORS, rand)) {
      if (distractors.length >= choices - 1) break;
      if (jaccard(correctTokens, tokenize(g)) < 0.35) distractors.push(g);
    }

    // Fall back to fewer choices if we still cannot fill; but ensure at least 2
    const finalChoices = [correct, ...distractors].slice(0, Math.max(2, choices));
    const shuffled = seededShuffle(finalChoices, rand);

    items.push({
      word: r.word,
      pos: primary.pos || "",
      correct,
      example: showExamples ? (primary.example || "") : "",
      choices: shuffled,
      correctIndex: shuffled.indexOf(correct),
      selected: -1,
      result: null
    });
  }

  // Prepare state and UI
  const state = {
    items,
    index: 0,
    correct: 0,
    seed: seedStr,
    choices,
    showExamples,
    missing: bad.map(b => b.word)
  };

  renderQuiz(state);
}

function renderQuiz(state) {
  $("#loading").hidden = true;
  $("#quiz").hidden = false;
  $("#results").hidden = true;

  $("#score").textContent = `Score: ${state.correct} / ${state.items.length}`;
  updateProgress(state);

  const wrap = $("#q-wrap");
  wrap.innerHTML = "";
  wrap.appendChild(renderQuestionCard(state));

  $("#prev").disabled = state.index === 0;
  $("#next").disabled = state.index >= state.items.length - 1;
  $("#finish").disabled = state.items.every(it => it.result !== null) ? false : true;

  $("#prev").onclick = () => { if (state.index>0) { state.index--; renderQuiz(state); } };
  $("#next").onclick = () => { if (state.index < state.items.length-1) { state.index++; renderQuiz(state); } };
  $("#finish").onclick = () => finishQuiz(state);
  $("#new-quiz").onclick = () => {
    $("#quiz").hidden = true;
    $("#builder").hidden = false;
  };
}

function renderQuestionCard(state) {
  const q = state.items[state.index];
  const card = document.createElement("div");
  card.className = "question-card";

  const title = document.createElement("div");
  title.className = "question-title";
  title.innerHTML = `What does <b>${escapeHtml(q.word)}</b><span class="pos">${q.pos ? " ("+q.pos+")" : ""}</span> mean?`;
  card.appendChild(title);

  const choices = document.createElement("div");
  choices.className = "choices";
  q.choices.forEach((text, i) => {
    const id = `q${state.index}_opt${i}`;
    const lbl = document.createElement("label");
    lbl.className = "choice";
    const input = document.createElement("input");
    input.type = "radio"; input.name = "choice"; input.id = id; input.value = i;
    input.checked = q.selected === i;
    input.onchange = () => { q.selected = i; };
    const span = document.createElement("div");
    span.textContent = text;

    lbl.appendChild(input);
    lbl.appendChild(span);
    choices.appendChild(lbl);
  });
  card.appendChild(choices);

  const feedback = document.createElement("div");
  feedback.className = "feedback"; feedback.id = "feedback";
  card.appendChild(feedback);

  const row = document.createElement("div");
  row.className = "controls";
  const btnCheck = document.createElement("button");
  btnCheck.className = "btn"; btnCheck.textContent = q.result === null ? "Check answer" : "Checked";
  btnCheck.disabled = q.result !== null;
  btnCheck.onclick = () => {
    if (q.selected === -1) {
      feedback.className = "feedback show";
      feedback.innerHTML = '<span class="error">Please choose an option first.</span>';
      return;
    }
    q.result = (q.selected === q.correctIndex);
    if (q.result) state.correct++;

    // Visual feedback
    const choiceEls = $$(".choice", card);
    choiceEls.forEach((el, i) => {
      el.classList.remove("correct", "incorrect");
      if (i === q.correctIndex) el.classList.add("correct");
      if (i === q.selected && !q.result) el.classList.add("incorrect");
      $("input", el).disabled = true;
    });

    $("#score").textContent = `Score: ${state.correct} / ${state.items.length}`;
    btnCheck.textContent = "Checked"; btnCheck.disabled = true;

    const lines = [];
    lines.push(q.result ? "✅ Correct!" : "❌ Not quite.");
    lines.push(`<b>Correct:</b> ${escapeHtml(q.choices[q.correctIndex])}`);
    if (q.example) lines.push(`<b>Example:</b> ${escapeHtml(q.example)}`);
    feedback.className = "feedback show";
    feedback.innerHTML = lines.map(l => `<div>${l}</div>`).join("");
    updateProgress(state);
    $("#finish").disabled = state.items.some(it => it.result === null);
  };

  const btnSkip = document.createElement("button");
  btnSkip.className = "btn secondary"; btnSkip.textContent = "Skip";
  btnSkip.onclick = () => { state.index = Math.min(state.index+1, state.items.length-1); renderQuiz(state); };

  const spacer = document.createElement("span"); spacer.className = "spacer";

  row.appendChild(btnCheck);
  row.appendChild(btnSkip);
  row.appendChild(spacer);

  const btnPrev = document.createElement("button");
  btnPrev.className = "btn ghost"; btnPrev.textContent = "Previous";
  btnPrev.onclick = () => { if (state.index>0) { state.index--; renderQuiz(state); } };
  const btnNext = document.createElement("button");
  btnNext.className = "btn"; btnNext.textContent = (state.index === state.items.length-1) ? "Finish" : "Next";
  btnNext.onclick = () => {
    if (state.index === state.items.length-1) finishQuiz(state);
    else { state.index++; renderQuiz(state); }
  };

  row.appendChild(btnPrev);
  row.appendChild(btnNext);
  card.appendChild(row);

  return card;
}

function updateProgress(state) {
  const answered = state.items.filter(it => it.result !== null).length;
  const pct = Math.round((answered / Math.max(1, state.items.length)) * 100);
  $("#progress-bar").style.width = pct + "%";
}

function finishQuiz(state) {
  $("#quiz").hidden = true;
  $("#results").hidden = false;

  const total = state.items.length;
  const correct = state.correct;
  const pct = Math.round((correct/Math.max(1,total))*100);
  $("#final-score").textContent = `You scored ${correct} out of ${total} (${pct}%).`;
  const missing = state.missing && state.missing.length ? `Missing words (no definition found): ${state.missing.join(", ")}.` : "";
  $("#summary").innerHTML = `${missing ? '<div class="small">'+escapeHtml(missing)+'</div>' : ''}`;

  const review = $("#review"); review.innerHTML = "";
  state.items.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "card"; div.style.padding = "12px";
    const head = document.createElement("div");
    head.innerHTML = `<div class="kicker">Question ${idx+1}</div><div style="font-weight:800">${escapeHtml(q.word)}${q.pos ? ' <span class="pos">('+q.pos+')</span>' : ''}</div>`;
    const correct = document.createElement("div");
    correct.innerHTML = `<div><b>Correct:</b> ${escapeHtml(q.choices[q.correctIndex])}</div>`;
    const your = document.createElement("div");
    const yourText = q.selected>=0 ? q.choices[q.selected] : "(no answer)";
    your.innerHTML = `<div><b>Your answer:</b> ${escapeHtml(yourText)} ${q.result ? "✅" : "❌"}</div>`;
    div.appendChild(head);
    div.appendChild(correct);
    div.appendChild(your);
    if (q.example) {
      const ex = document.createElement("div"); ex.className = "small"; ex.style.marginTop = "6px";
      ex.innerHTML = `<b>Example:</b> ${escapeHtml(q.example)}`;
      div.appendChild(ex);
    }
    review.appendChild(div);
  });

  $("#retry").onclick = () => {
    // reshuffle choices deterministically with a new seed
    const newSeed = String(Math.floor(Math.random()*1e9));
    const params = new URL(location.href).searchParams;
    params.set("seed", newSeed);
    location.search = params.toString();
  };
  const copyLink = () => {
    const u = new URL(location.href);
    copyToClipboard(u.toString()).then(() => alert("Link copied to clipboard!"));
  };
  $("#copy-share-2").onclick = copyLink;
  $("#builder-again").onclick = () => { $("#results").hidden = true; $("#builder").hidden = false; };
}

function escapeHtml(s){
  return (s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[c]));
}

/* ---------- Builder UI wiring ---------- */
function initBuilder() {
  const params = new URL(location.href).searchParams;
  const hasWordsInURL = !!params.get("words") || (location.hash.startsWith("#words="));
  if (hasWordsInURL) {
    // If words are present, auto-build quiz using URL
    const words = parseWordsFromParams();
    $("#builder").hidden = true;
    $("#loading").hidden = false;

    const choices = parseInt(params.get("choices") || "4", 10);
    const showExamples = params.get("examples") !== "0";
    const seed = params.get("seed") || "";

    buildQuizFromWords(words, { choices, seed, showExamples });
    return;
  }

  // Otherwise show builder
  $("#builder").hidden = false;

  const wordsTA = $("#words");
  const countInput = $("#choices-count");
  const showEx = $("#show-examples");
  const seedInput = $("#shuffle-seed");
  const buildBtn = $("#build-quiz");
  const copyBtn = $("#copy-share");
  const sampleBtn = $("#try-sample");

  const updateShare = debounce(() => {
    const words = wordsTA.value.split(/[\n,]/).map(s => s.trim()).filter(Boolean);
    const u = new URL(location.href);
    u.searchParams.set("words", words.join(","));
    u.searchParams.set("choices", String(Math.max(2, Math.min(6, parseInt(countInput.value || "4", 10)))));
    u.searchParams.set("examples", showEx.checked ? "1" : "0");
    if (seedInput.value.trim()) u.searchParams.set("seed", seedInput.value.trim());
    else u.searchParams.delete("seed");
    $("#builder-msg").innerHTML = `Shareable link prepared. Click <b>Copy share link</b> or <b>Build quiz</b> to use it.`;
    return u.toString();
  }, 150);

  const currentShare = () => {
    const u = new URL(location.href);
    const words = wordsTA.value.split(/[\n,]/).map(s => s.trim()).filter(Boolean);
    u.searchParams.set("words", words.join(","));
    u.searchParams.set("choices", String(Math.max(2, Math.min(6, parseInt(countInput.value || "4", 10)))));
    u.searchParams.set("examples", showEx.checked ? "1" : "0");
    if (seedInput.value.trim()) u.searchParams.set("seed", seedInput.value.trim());
    else u.searchParams.delete("seed");
    return u.toString();
  };

  wordsTA.addEventListener("input", updateShare);
  countInput.addEventListener("input", updateShare);
  showEx.addEventListener("change", updateShare);
  seedInput.addEventListener("input", updateShare);

  buildBtn.onclick = () => {
    const words = wordsTA.value.split(/[\n,]/).map(s => s.trim()).filter(Boolean);
    if (words.length === 0) {
      $("#builder-msg").innerHTML = '<span class="error">Please enter at least one word.</span>';
      return;
    }
    // Update URL then reload quiz area
    const u = new URL(location.href);
    u.searchParams.set("words", words.join(","));
    u.searchParams.set("choices", String(Math.max(2, Math.min(6, parseInt(countInput.value || "4", 10)))));
    u.searchParams.set("examples", showEx.checked ? "1" : "0");
    if (seedInput.value.trim()) u.searchParams.set("seed", seedInput.value.trim());
    history.replaceState(null, "", u.toString());
    // Start building
    buildQuizFromWords(words, { choices: parseInt(countInput.value || "4", 10), seed: seedInput.value.trim(), showExamples: showEx.checked });
  };

  copyBtn.onclick = () => {
    const link = currentShare();
    copyToClipboard(link).then(() => alert("Share link copied!"));
  };

  sampleBtn.onclick = () => {
    wordsTA.value = "philanthropy, obsequious, emancipated, jurisdiction, doctrine, converge, equivocate";
    countInput.value = "4"; showEx.checked = true; seedInput.value = "";
    $("#builder-msg").textContent = "Sample words loaded.";
  };
}

// Start
initBuilder();
</script>
</body>
</html>
